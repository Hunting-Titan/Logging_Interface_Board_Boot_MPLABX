<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Logging Panel  Interface Board: Revision</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Logging Panel  Interface Board<span id="projectnumber">&#160;1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_revision.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Revision</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Revision 1.00</b></p>
<p>This is the initial code used for the Floresville testing and sales demo. The project Panel Interface Board reflects this revision.</p>
<p><b>Revision 1.01</b></p>
<p>This revision resulted from the initial testing at Denver. The code updates were as follows:</p>
<ul>
<li>auto_cf.c<ul>
<li>Function AUTO_CF_Tasks in state AUTO_CF_STATE_CHECK. Added ability to calculate wireline resistance to help determine if a shot has occurred. <br  />
 It is looking for a 90 ohm change in resistance in successive readings. The initial shot detection success rate was only approx. 60%. This along with reducing the current change threshold to 120mA from 200mA allowed the code to properly respond to the recorded data.</li>
</ul>
</li>
<li>hvps.c<ul>
<li>Function HVPS_Tasks in state HVPS_STATE_EVENT_CHECK. Ensure all auto_cf variables are reset after a shot event occurs or if there was an error.</li>
</ul>
</li>
</ul>
<p><b>Revision 1.02</b></p>
<p>This revision addresses issues found in further testing of revision 1.01.</p>
<ul>
<li>auto_cf.c<ul>
<li>Function AUTO_CF_Tasks in state AUTO_CF_STATE_CHECK. Added further checks to make sure shot detect is within time window and that ENABLE switch is pushed. Clear all shot detect variables if not within window or ENABLE switch is released.</li>
</ul>
</li>
<li>cf.c<ul>
<li>Function CF_Tasks in state CF_STATE_INIT. Added code to initialize averaging variables.</li>
<li>Function CF_Tasks in state CF_STATE_READ_I. Added averaging code similar to Wl_SPS current average to average 5 readings of CF_current. This alleviated false one reading changes that tripped the shot detection limits.</li>
</ul>
</li>
<li>cf.h<ul>
<li>Added variables to accommodate the CF_current averaging.</li>
</ul>
</li>
<li><p class="startli">hvps.c</p><ul>
<li>Function HVPS_Tasks in state HVPS_STATE_CHECK_OVERCURRENT. Removed check for panel switch being in ARM_CF or AUTO ARM_CF mode to reset hvps current flag. This caused issues when a shot did not occur.</li>
</ul>
<p class="startli"><b>Revision 1.03</b></p>
</li>
</ul>
<p>This revision addresses issues found in further testing of revision 1.02.</p>
<ul>
<li><p class="startli">hvps.c</p><ul>
<li>Function HVPS_Tasks in state HVPS_STATE_EVENT_CHECK. Moved statement to reset HV_PS.ramp_start flag to immediately after shot detection. Keeps auto ramp from occurring twice.</li>
</ul>
<p class="startli"><b>Revision 1.04</b></p>
</li>
</ul>
<p>This revision addresses issues found in further testing of revision 1.03.</p>
<ul>
<li>man.c<ul>
<li>Function Test_Manchester added function to return FSK to original value after finding a switch. This is the same as the Verifire code. This helps finding ver.1.8 switches especially. The MAN Bias adjustments found in the Verifire are not used here. <br  />
</li>
</ul>
</li>
<li>hvps.c<ul>
<li>Function HVPS_Tasks in state HVPS_STATE_EVENT_CHECK. Moved statement to reset HV_PS.run_time_count to immediately after shot detection. Ensures proper count reset instead of waiting for WL_SPS to decay.</li>
</ul>
</li>
</ul>
<p><b>Revision 1.05</b></p>
<p>This revision addresses issues found in further testing of revision 1.04.</p>
<ul>
<li><p class="startli">man.c</p><ul>
<li>Function Test_Manchester remove check for switch data command. Always check switch status bits to ensure a good command response. Apply FSK change if a bad command response is received. <br  />
</li>
</ul>
<p class="startli"><b>Revision 1.06</b></p>
</li>
</ul>
<p>This revision addresses issues found in further testing of revision 1.05. <br  />
 PerfSwitch temperature testing while communicating with the panel showed extra FSK transmissions due the FSK reset from rev. 1.04. Testing showed this is not required for good performance.</p>
<ul>
<li>man.c<ul>
<li>Function Test_Manchester remove FSK reset to original FSK after a good switch communication. Remove CMD.switch status bit check flag.</li>
</ul>
</li>
</ul>
<p><b>Revision 1.107</b></p>
<p>Update to change revision level meaning. The whole part of the number represents the controller memory. 1 equals 512, 2 equals 1024, 3 equals 2048. The fractional represents the code revision number. The rev number was changed to a 16 bit number to accommodate the change.</p>
<p><b>Revision 1.108</b></p>
<p>Update to change hvps_test. No voltages are checked. This alleviates hardware variances causing random system check failures.</p>
<ul>
<li>hvps_test.c<ul>
<li>Update HVPS_TEST_STATE_INIT_TEST state in HVPS_Test_Tasks function to skip to state HVPS_TEST_STATE_CHECK_TEST_DONE. Test count has been updated to force test to end properly so rest of program can continue.</li>
</ul>
</li>
</ul>
<p><b>Revision 1.109</b></p>
<p>Update to auto_cf to turn supply off if shooting current limit is reached. <br  />
 The same status bit for a shot detection is set. This is read by the host. The host then checks if the switch actually fired. Also update to keep current less than shooting current while in ARM_CF and both buttons are used. This keeps current from trailing up is detonator resistance starts to drop.</p>
<ul>
<li>auto_cf.c<ul>
<li>Update AUTO_CF_STATE_CHECK state to check if average current is greater than the shooting current limit while in ARM_CF_AUTO. Set shot detection status bit. <br  />
</li>
</ul>
</li>
<li>hvps.c<ul>
<li>Update HVPS_STATE_CHECK_OVERCURRENT state so HVPS control voltage is decreased if the HV_PS current is greater than the shooting current limit while in ARM_CF and both the fire and enable buttons are used. The control voltage is then increased once the current is less than the shooting current limit. This keeps the current near the shooting current limit for the duration of the shot window.</li>
</ul>
</li>
</ul>
<p><b>Revision 1.110</b></p>
<p>Update to auto_cf to disable shot detection when a power charge is being fired. Two commands are added. Command 0x3B to disable shot detection; command 0x3C to enable shot detection. Shot detection is always enabled by default.</p>
<ul>
<li>auto_cf.c<ul>
<li>Update AUTO_CF_STATE_WAIT state to add flag check for shot detection disable.</li>
</ul>
</li>
<li><a class="el" href="commands_8c.html">commands.c</a><ul>
<li>Add two commands to accommodate the new feature. Command 0x3B disables shot detection. Command 0x3c enables shot detection. This must be used after a power charge is fired. Shot detection is enabled by default at start up.</li>
</ul>
</li>
</ul>
<p><b>Revision 1.111</b></p>
<p>Update to switches to check if user releases the ENABLE button during a power charge shot. If it is released, the status 2 bit is cleared to indicate this. <br  />
</p>
<ul>
<li>switches.c<ul>
<li>Update the NO FIRE case in SW_COM.S1_state to check if it released during a power charge. If so, clear the Status 2 bit.</li>
</ul>
</li>
</ul>
<p><b>Revision 1.112</b></p>
<p>Update to use STATUS front panel switch LED to indicate system problems instead of DUMP FIRE LED. <br  />
</p>
<ul>
<li><a class="el" href="system__okay_8c.html">system_okay.c</a><ul>
<li>Switch to STATUS_LED to indicate issue with system testing at startup.</li>
</ul>
</li>
<li>hvps.c<ul>
<li>Switch to STATUS LED to indicate problem with HVPS supply.</li>
</ul>
</li>
<li>switches.c<ul>
<li>Switch to STATUS LED to indicate problem with HVPS supply.</li>
</ul>
</li>
</ul>
<p><b>Revision 1.113</b></p>
<p>Update to create 1 second wait state after current spike or an HVPS is found. Needed so HVPS can be reset properly by sending 0V control voltage. Sending too soon allows HVPS to shutdown. The wait state prevents that.</p>
<ul>
<li><a class="el" href="timers_8c.html">timers.c</a><ul>
<li>Add 100mS HV_PS.spike_delay_tick.</li>
</ul>
</li>
<li>hvps.h<ul>
<li>Add variables spike_delay_tick and spike_delay_count along with HVPS_STATE_SPIKE_WAIT case. These are used to control wait state.</li>
</ul>
</li>
<li>hvps.c<ul>
<li>Add code in case HVPS_STATE_EVENT_CHECK to move to HVPS_STATE_SPIKE_WAIT state when spike or timeout event has occurred. HVPS_STATE_SPIKE_WAIT state creates a one second delay before moving on to send 0V control value to HVPS DAC. <br  />
</li>
</ul>
</li>
</ul>
<p><b>Revision 1.114</b></p>
<p>Update to use 4 to 20mA signal from APM voltmeter to calculate the WL_SPS voltage value. For Rev. B PCBs and later. Create WL_SPS_V function to convert the 4 to 20 mA signal to a voltage. Also use flags to indicate that new hardware is present. This allows older boards to use this revision and later.</p>
<ul>
<li>wl_sps_v.c and wl_sps_v.h<ul>
<li>New functions to convert the 4 to 20mA signal into a voltage that the panel can use.</li>
</ul>
</li>
<li>system_interrupt.c<ul>
<li>Add two ADC channels to accommodate the APM current input and a channel to act as a switch to indicate that the new hardware is installed.</li>
</ul>
</li>
<li>wl_sps.c<ul>
<li>Add code in state WL_SPS_STATE_READ_V to check flag for new hardware.</li>
</ul>
</li>
</ul>
<p><b>Revision 1.115</b></p>
<p>Update to fix bug in over current control while in ARM mode. Unit was not turning off supply correctly. Now unit performs as expected. After overcurrent occurs, supply goes to minimum and STATUS LED stays lit until control pot is turned off.</p>
<ul>
<li>switches.c<ul>
<li>Update switch case ( SW_COM.S5_state ) for HVPS_ON to remove reset for HV_PS.pot_switch to false. <br  />
</li>
</ul>
</li>
<li>hvps.c<ul>
<li>Remove extra flag check for HVPS control SPI write. This was causing the system to occasionally hang if the flag was not cleared correctly.</li>
</ul>
</li>
</ul>
<p><b>Revision 1.116</b></p>
<p>Update to reduce voltage threshold for shot detection. The voltage threshold is now 20V instead of 50V. This is to accommodate the slower response time of the wire-line voltmeter. The meter outputs approx. 30V instead of 50 to 60V that is actually on the line. This led to some missed shot detection.</p>
<ul>
<li>auto_cf.c<ul>
<li>Update switch case ( AUTO_CF_STATE_WAIT.state ) for WL_SPS.voltage &gt; 20U. * <br  />
</li>
</ul>
</li>
</ul>
<p><b>Revision 1.117</b></p>
<p>Update to control HVPS turn off when in ARM mode. This will alleviate unit sometimes locking up due to current/voltage spike that occurs when HVPS and DUMP FIRE relay opened when the ENABLE button was released and power was still applied to a load. The unit now reduces the HVPS voltage to 35V before opening the two relays. This prevents the spikes from occurring and the unit does not lock up.</p>
<ul>
<li>switches.c<ul>
<li>Update switch SW_COM.S1_state in case RLY_NO_FIRE. Remove turning off HVPS and DUMP_FIRE relays. Instead reset flag (HV_PS.fire_auto_run_flag) when in ARM or ARM_CF modes and the ENABLE button has been released. This flag is used in hvps.c turn properly turn off the HVPS before opening the relays.</li>
</ul>
</li>
<li>hvps.c<ul>
<li>Update to function HVPS_Tasks. Update switch case HVPS_STATE_SHUTDOWN_CHECK to turn off HVPS and DUMP_FIRE relays when the wire-line voltage is less than 40V. This keeps spikes from occurring.</li>
<li>Update to switch case HVPS_STATE_EVENT_CHECK. Do not use HVPS wait when in ARM mode. The WAIT is only needed in ARM_CF or AUTO_CF.</li>
</ul>
</li>
</ul>
<p><b>Revision 1.118</b></p>
<p>Update to reduce the rate the voltage changes to maintain a given plug current. <br  />
 This is hoped to alleviate current spikes during Recon plug shoots. Also disable software overcurrent checks during plug shoot.</p>
<ul>
<li>hvps.c<ul>
<li>Update switch case ( HVPS_STATE_CHECK_OVERCURRENT.state ) so the increase rates are at 1500 instead of 100. This slows the increase rate down.</li>
<li>Function Set_HVPS_Ramp_Rate. Store programmed increase rate to use after plug shot is completed.</li>
<li>Function HVPS_Tasks in switch case HVPS_STATE_SHUTDOWN_CHECK. Restore original updates rates after plug shoot.</li>
<li>Function HVPS_Tasks in switch case HVPS_STATE_EVENT_CHECK. Restore original updates rates after plug shoot.</li>
<li>Function HVPS_Tasks in switch case HVPS_STATE_CHECK_OVERCURRENT. Change update rates to slow increase and raise decrease to try and alleviate current spikes during plug shoot. Also, add check to disable overcurrent flag during plug shoot.</li>
</ul>
</li>
<li>wl_sps.c<ul>
<li>Function WL_SPS_Tasks in switch case WL_SPS_STATE_CHECK_OVERCURRENT. Add check to disable overcurrent flag during plug shoot.</li>
</ul>
</li>
<li>cf.c<ul>
<li>Function CF_Tasks in switch case CF_STATE_CHECK_OVERCURRENT. Add check to disable overcurrent flag during plug shoot.</li>
</ul>
</li>
<li>switches.c<ul>
<li>Function execute switches in switch case SW_COM.S5_state (HVPS_OFF). Add check to turn off relays if plug shoot is not occurring.</li>
</ul>
</li>
</ul>
<p><b>Revision 1.119</b></p>
<p>Update to fix erroneous message errors with some switch combinations. Found that using Rev. 2.1 V3 switch after a safety sub did not allow the deto to be read properly. Found that the Manchester Bias DAC voltage need to be increased to allow the deto to be read properly. Implemented similar method from old panel. Reviewed old panel code and also updated the method to modify the FSK signals for use over temperature. <br  />
</p>
<ul>
<li><a class="el" href="fsk_8c.html">fsk.c</a> <br  />
<ul>
<li>Update function Generate_Sine_Wave_Data to vary the spacing between FSK DAC updates by a variable amount instead a constant fixed amount based on the switch preamble time response. This will account for fractional time changes more accurately.</li>
</ul>
</li>
<li>man.c<ul>
<li>Update function Calc_Auto_Bias to increase the DAC bias voltage for a given wireline current. Also implement a straight line equation for the DAC value based on the wireline current. This is similar to the old panel method. The equation is based on emperical results.</li>
</ul>
</li>
</ul>
<p>NOTE: This version has field issues with switch communication at Haliburton site. This led to further investigations with versions with versions X.120 to X.123.</p>
<p><b>Revision 1.120</b></p>
<p>Update to control HVPS turn off. Found that some situations caused the HVPS to go into a lockout condition when the HVPS is turned off. If the HVPS voltage change occurs too quickly, the HVPS goes into a lockout condition until it recovers. This caused issues when using AUTO_CF as a gun was missed. A controlled turn off has been implemented to keep the HVPS from seeing large changes on the output.</p>
<ul>
<li>switches.c <br  />
<ul>
<li>Update function execute switches in switch (SW_COM.S1_state) case RLY_NO_FIRE to reinitialize HV_PS.fire_auto_run_flag. Also reinitialize this flag in case RLY_FIRE. Update switch (SW_COM.S5_state) case HVPS_OFF to modify logic when relays turn off. Allows voltage to go to zero during plug shoot.</li>
</ul>
</li>
<li>hvps.c<ul>
<li>Update function HVPS_Tasks in switch case HVPS_STATE_SHUTDOWN_CHECK to add variables needed to properly power down HVPS after shutdown event has occurred. Relays open after supply is less than 40V. Update switch case HVPS_STATE_EVENT_CHECK to add check to go to power down when needed. Add variables to properly power down HVPS. Move WL_SPS check to outside event check so unit can power down properly. Update case HVPS_STATE_CALC_SETTING to bypass getting HVPS control voltage when a run is complete. Update case HVPS_STATE_CHECK_OVERCURRENT for added check for run completion when HVPS output needs to increase. Update case HVPS_STATE_ABORT so HVPS can power down correctly.</li>
</ul>
</li>
</ul>
<p>NOTE: FSK was set back to VX.118 and the straight line MAN bis adj. remained. Still had issues with reading switch V3 deto values after safety sub. VERSION NOT RELEASED.</p>
<p><b>Revision 1.121</b> </p><pre class="fragment">   Kept FSK like VX.118 and tried MAN DAC bias values from old panel.  MAN DAC 
   bias results too low for proper operation.  VERSION NOT RELEASED.
</pre><p><b>Revision 1.122</b> </p><pre class="fragment">   Added additional MAN bias adj during FSK adjustment.  Changed MAN preamble
   time to account for long bit increase in switch.  Similar results with still
   bad results trying to read switch deto values after a safety sub.  VERSION 
   NOT RELEASED.
</pre><p><b>Revision 1.123</b> </p><pre class="fragment">   Changed minimum Manchester bit time from 320uS to 1mS. This allowed proper 
   deto values to be read from switch V3 after a safety sub.  Temperature 
   testing also showed that the FSK shifts need to be limited to 2%.  This kept 
   changes reasonable based on Manchester counts.  Removed additional MAN bias 
   adjustment.  Also moved FSK baud value to 400Hz.
</pre><ul>
<li><a class="el" href="fsk_8c.html">fsk.c</a> <br  />
<ul>
<li>Update function Init_FSK to change FSK.baud to 400Hz. Also tweak DAC counts between FSK DAC updates, increasing mark and space counts by one. This lowers FSK frequencies a little.</li>
</ul>
</li>
<li>man.h<ul>
<li>Change ManHalfLower value to represent 1mS instead of 320uS. This helps system ignore current pulses during the switch deto resistance measurement. That measurement generates a 5mA current pulse that the system would sometimes misread as a MAnchester response. This caused comm. issues.</li>
</ul>
</li>
<li>man.c<ul>
<li>Update function Calc_Fsk_Scaling to limit the amount of change (2%)based on the Manchester preamble response. Excessive FSK changes could lead to comm. errors. Remove Man.bias_adj introduced in V1.122 from functions Test_Manchester and Calc_Auto_Bias. Remove MAN preamble bit time adjustment in V1.122. Move the MAN response timer count to the interrupt routine to reduce possible count variations. Create MAN.timer_value variable to use count recorded in the interrupt routine.</li>
</ul>
</li>
<li>system_interrupt.c<ul>
<li>Add MAN.timer_value = DRV_TMR2_CounterValueGet(); to Port A change notice routine for recording the Manchester bit times. </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
